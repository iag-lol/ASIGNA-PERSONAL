<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Terminal El Roble | Sistema de Gestión</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* Colors - Enterprise Palette */
            --primary-900: #0f2e54;
            --primary-800: #113c6e;
            --primary-700: #194980;
            --primary-600: #1d579c;
            --primary-500: #2563b3;
            --primary-400: #3b75c2;
            --primary-300: #5088cf;
            --primary-200: #84aee0;
            --primary-100: #c2d5f1;
            --primary-50: #e1ebf9;

            --success-700: #0f5132;
            --success-600: #166534;
            --success-500: #14804c;
            --success-400: #16a34a;
            --success-300: #4ade80;
            --success-100: #dcfce7;
            --success-50: #f0fdf4;

            --gray-900: #111827;
            --gray-800: #1f2937;
            --gray-700: #374151;
            --gray-600: #4b5563;
            --gray-500: #6b7280;
            --gray-400: #9ca3af;
            --gray-300: #d1d5db;
            --gray-200: #e5e7eb;
            --gray-100: #f3f4f6;
            --gray-50: #f9fafb;

            --danger-600: #dc2626;
            --danger-500: #ef4444;
            --danger-400: #f87171;
            --danger-100: #fee2e2;
            --danger-50: #fef2f2;

            --warning-600: #ea580c;
            --warning-500: #f97316;
            --warning-100: #ffedd5;
            --warning-50: #fff7ed;

            --info-600: #0284c7;
            --info-500: #0ea5e9;
            --info-100: #e0f2fe;
            --info-50: #f0f9ff;

            /* Shadows */
            --shadow-xs: 0 1px 2px rgba(16, 24, 40, 0.05);
            --shadow-sm: 0 1px 3px rgba(16, 24, 40, 0.1), 0 1px 2px rgba(16, 24, 40, 0.06);
            --shadow-md: 0 4px 8px -2px rgba(16, 24, 40, 0.1), 0 2px 4px -2px rgba(16, 24, 40, 0.06);
            --shadow-lg: 0 12px 16px -4px rgba(16, 24, 40, 0.08), 0 4px 6px -2px rgba(16, 24, 40, 0.03);
            --shadow-xl: 0 20px 24px -4px rgba(16, 24, 40, 0.08), 0 8px 8px -4px rgba(16, 24, 40, 0.03);

            /* Typography */
            --font-primary: 'Inter', system-ui, -apple-system, sans-serif;

            /* Border Radius */
            --radius-sm: 4px;
            --radius-md: 6px;
            --radius-lg: 8px;
            --radius-xl: 12px;
            --radius-2xl: 16px;
            --radius-full: 9999px;

            /* Z-Index */
            --z-dropdown: 100;
            --z-sticky: 200;
            --z-fixed: 300;
            --z-modal: 400;
            --z-popover: 500;
            --z-tooltip: 600;
        }

        /* Reset */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 14px;
            -webkit-text-size-adjust: 100%;
        }

        body {
            font-family: var(--font-primary);
            color: var(--gray-800);
            background-color: var(--gray-100);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            height: 100vh;
            overflow-x: hidden;
        }

        /* Typography */
        h1, h2, h3, h4, h5, h6 {
            font-weight: 600;
            line-height: 1.3;
            color: var(--gray-900);
        }

        /* Layout */
        .app-container {
            display: grid;
            grid-template-rows: auto 1fr;
            min-height: 100vh;
            max-width: 1920px;
            margin: 0 auto;
            background-color: var(--gray-100);
        }

        /* Sidebar */
        .app-sidebar {
            background-color: var(--primary-800);
            color: white;
            width: 280px;
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            z-index: var(--z-fixed);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-text {
            font-size: 1.25rem;
            font-weight: 600;
            color: white;
            letter-spacing: -0.01em;
        }

        .sidebar-version {
            font-size: 0.65rem;
            padding: 0.25rem 0.5rem;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-full);
            color: rgba(255, 255, 255, 0.7);
        }

        .sidebar-content {
            flex: 1;
            padding: 1.25rem;
            overflow-y: auto;
        }

        .sidebar-footer {
            padding: 1rem 1.25rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* Navigation */
        .nav-section {
            margin-bottom: 2rem;
        }

        .nav-header {
            text-transform: uppercase;
            font-size: 0.65rem;
            font-weight: 600;
            letter-spacing: 0.05em;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 0.75rem;
            padding: 0 0.5rem;
        }

        .nav-list {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 0.25rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 0.75rem;
            border-radius: var(--radius-md);
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .nav-link.active {
            background-color: rgba(255, 255, 255, 0.15);
            color: white;
            font-weight: 500;
        }

        .nav-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 1.5rem;
            font-size: 1rem;
        }

        /* Main Content */
        .app-main {
            margin-left: 280px;
            min-height: 100vh;
            background-color: var(--gray-100);
            overflow-x: hidden;
            transition: margin-left 0.3s ease;
        }

        .app-header {
            position: sticky;
            top: 0;
            z-index: var(--z-sticky);
            background-color: white;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-sm);
        }

        .app-title {
            font-weight: 600;
            font-size: 1.25rem;
            color: var(--gray-900);
        }

        .app-content {
            padding: 1.5rem;
        }

        /* Mobile menu toggle */
        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            color: var(--gray-600);
            font-size: 1.25rem;
            cursor: pointer;
        }

        /* Connection status */
        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--success-400);
        }

        .status-dot.error {
            background-color: var(--danger-500);
        }

        /* Cards */
        .card {
            background-color: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            overflow: hidden;
            margin-bottom: 1.5rem;
            border: 1px solid var(--gray-200);
            transition: all 0.2s ease;
        }

        .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            background-color: var(--gray-50);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-title {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--gray-900);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-title i {
            color: var(--primary-500);
            font-size: 1.2rem;
        }

        .card-subtitle {
            font-size: 0.85rem;
            color: var(--gray-500);
            margin-top: 0.25rem;
        }

        .card-body {
            padding: 1.5rem;
        }

        /* Grid System */
        .grid {
            display: grid;
            gap: 1.5rem;
        }

        .grid-cols-1 {
            grid-template-columns: 1fr;
        }

        .grid-cols-2 {
            grid-template-columns: repeat(2, 1fr);
        }

        .grid-cols-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        .grid-cols-4 {
            grid-template-columns: repeat(4, 1fr);
        }

        /* Responsive grid adjustments */
        @media (max-width: 1440px) {
            .grid-cols-4 {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 1280px) {
            .grid-cols-3, .grid-cols-4 {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .grid-cols-2, .grid-cols-3, .grid-cols-4 {
                grid-template-columns: 1fr;
            }
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }

        .form-control {
            display: block;
            width: 100%;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            font-weight: 400;
            line-height: 1.5;
            color: var(--gray-900);
            background-color: white;
            background-clip: padding-box;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            transition: all 0.15s ease-in-out;
        }

        .form-control:focus {
            border-color: var(--primary-500);
            outline: 0;
            box-shadow: 0 0 0 3px rgba(37, 99, 179, 0.1);
        }

        .form-control::placeholder {
            color: var(--gray-400);
        }

        .form-control:disabled {
            background-color: var(--gray-100);
            opacity: 0.7;
            cursor: not-allowed;
        }

        .form-select {
            display: block;
            width: 100%;
            padding: 0.75rem 2.25rem 0.75rem 1rem;
            font-size: 0.875rem;
            font-weight: 400;
            line-height: 1.5;
            color: var(--gray-900);
            background-color: white;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Cpath fill='none' stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 16px 12px;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            appearance: none;
            transition: all 0.15s ease-in-out;
        }

        .form-select:focus {
            border-color: var(--primary-500);
            outline: 0;
            box-shadow: 0 0 0 3px rgba(37, 99, 179, 0.1);
        }

        .form-select:disabled {
            background-color: var(--gray-100);
            opacity: 0.7;
            cursor: not-allowed;
        }

        .form-select[multiple] {
            padding-right: 0.75rem;
            background-image: none;
            height: auto;
            min-height: 120px;
        }

        /* Form Layout */
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-col {
            flex: 1;
            min-width: 0;
        }

        /* Time input */
        .time-input-container {
            position: relative;
        }

        .time-input {
            padding-right: 2.5rem;
        }

        .time-input-icon {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-400);
            pointer-events: none;
        }

        /* Search input */
        .search-input {
            position: relative;
        }

        .search-input input {
            padding-left: 2.5rem;
        }

        .search-input i {
            position: absolute;
            left: 0.875rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-400);
            pointer-events: none;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            text-align: center;
            vertical-align: middle;
            user-select: none;
            border: 1px solid transparent;
            padding: 0.75rem 1.25rem;
            font-size: 0.875rem;
            line-height: 1.5;
            border-radius: var(--radius-md);
            transition: all 0.15s ease-in-out;
            cursor: pointer;
            gap: 0.5rem;
            white-space: nowrap;
        }

        .btn:focus {
            outline: 0;
            box-shadow: 0 0 0 3px rgba(37, 99, 179, 0.1);
        }

        .btn:disabled {
            opacity: 0.65;
            pointer-events: none;
            cursor: not-allowed;
        }

        /* Button sizes */
        .btn-sm {
            padding: 0.5rem 0.875rem;
            font-size: 0.75rem;
        }

        .btn-lg {
            padding: 0.875rem 1.5rem;
            font-size: 1rem;
        }

        .btn-icon {
            padding: 0.75rem;
            font-size: 1rem;
        }

        .btn-icon.btn-sm {
            padding: 0.5rem;
            font-size: 0.875rem;
        }

        /* Button variants */
        .btn-primary {
            color: white;
            background-color: var(--primary-600);
            border-color: var(--primary-600);
        }

        .btn-primary:hover {
            background-color: var(--primary-700);
            border-color: var(--primary-700);
        }

        .btn-primary:active {
            background-color: var(--primary-800);
            border-color: var(--primary-800);
        }

        .btn-success {
            color: white;
            background-color: var(--success-500);
            border-color: var(--success-500);
        }

        .btn-success:hover {
            background-color: var(--success-600);
            border-color: var(--success-600);
        }

        .btn-success:active {
            background-color: var(--success-700);
            border-color: var(--success-700);
        }

        .btn-danger {
            color: white;
            background-color: var(--danger-500);
            border-color: var(--danger-500);
        }

        .btn-danger:hover {
            background-color: var(--danger-600);
            border-color: var(--danger-600);
        }

        .btn-outline {
            color: var(--gray-700);
            background-color: white;
            border-color: var(--gray-300);
        }

        .btn-outline:hover {
            color: var(--gray-900);
            background-color: var(--gray-100);
            border-color: var(--gray-400);
        }

        .btn-outline-primary {
            color: var(--primary-600);
            background-color: white;
            border-color: var(--primary-300);
        }

        .btn-outline-primary:hover {
            color: white;
            background-color: var(--primary-600);
            border-color: var(--primary-600);
        }

        .btn-outline-danger {
            color: var(--danger-500);
            background-color: white;
            border-color: var(--danger-300);
        }

        .btn-outline-danger:hover {
            color: white;
            background-color: var(--danger-500);
            border-color: var(--danger-500);
        }

        /* Button groups */
        .btn-group {
            display: inline-flex;
            vertical-align: middle;
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .btn-group>.btn {
            position: relative;
            flex: 1 1 auto;
            border-radius: 0;
        }

        .btn-group>.btn:not(:last-child) {
            border-right: 1px solid rgba(0, 0, 0, 0.1);
        }

        .btn-group>.btn:first-child {
            border-top-left-radius: var(--radius-md);
            border-bottom-left-radius: var(--radius-md);
        }

        .btn-group>.btn:last-child {
            border-top-right-radius: var(--radius-md);
            border-bottom-right-radius: var(--radius-md);
        }

        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 500;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: var(--radius-full);
        }

        .badge-primary {
            color: var(--primary-800);
            background-color: var(--primary-100);
        }

        .badge-success {
            color: var(--success-700);
            background-color: var(--success-100);
        }

        .badge-danger {
            color: var(--danger-600);
            background-color: var(--danger-100);
        }

        .badge-gray {
            color: var(--gray-700);
            background-color: var(--gray-200);
        }

        .badge-warning {
            color: var(--warning-600);
            background-color: var(--warning-100);
        }

        .badge-info {
            color: var(--info-600);
            background-color: var(--info-100);
        }

        /* Tables */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 1.5rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
        }

        .table {
            width: 100%;
            margin-bottom: 0;
            color: var(--gray-900);
            border-collapse: separate;
            border-spacing: 0;
        }

        .table th,
        .table td {
            padding: 1rem;
            vertical-align: middle;
        }

        .table thead th {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--gray-600);
            background-color: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
            text-align: left;
            padding-top: 0.875rem;
            padding-bottom: 0.875rem;
            position: relative;
        }

        .table thead th:not(:last-child)::after {
            content: '';
            position: absolute;
            right: 0;
            top: 25%;
            height: 50%;
            width: 1px;
            background-color: var(--gray-300);
        }

        .table tbody tr {
            transition: background-color 0.15s ease-in-out;
        }

        .table tbody tr:hover {
            background-color: var(--primary-50);
        }

        .table tbody td {
            border-bottom: 1px solid var(--gray-200);
            font-size: 0.875rem;
        }

        .table tbody tr:last-child td {
            border-bottom: none;
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem 1.5rem;
            text-align: center;
            background-color: var(--gray-50);
            border: 1px dashed var(--gray-300);
            border-radius: var(--radius-lg);
        }

        .empty-state-icon {
            font-size: 2.5rem;
            color: var(--gray-400);
            margin-bottom: 1.25rem;
        }

        .empty-state-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }

        .empty-state-description {
            font-size: 0.875rem;
            color: var(--gray-500);
            max-width: 24rem;
            margin: 0 auto 1.5rem;
        }

        /* Staff List */
        .staff-list {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            background-color: white;
        }

        .staff-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--gray-200);
            transition: all 0.15s ease-in-out;
        }

        .staff-item:last-child {
            border-bottom: none;
        }

        .staff-item:hover {
            background-color: var(--gray-50);
        }

        .staff-checkbox {
            margin-right: 0.75rem;
        }

        .staff-info {
            flex: 1;
            min-width: 0;
            font-size: 0.875rem;
            margin-top: 2px;
        }

        /* Assignment Row */
        #rows-container {
            max-height: 600px;
            overflow-y: auto;
            padding: 0.5rem;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            background-color: var(--gray-50);
        }

        .assignment-row {
            display: grid;
            grid-template-columns: 2fr 2fr 1fr 1fr 1fr auto;
            gap: 0.75rem;
            align-items: center;
            padding: 1rem 1.25rem;
            background-color: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            margin-bottom: 0.75rem;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-sm);
        }

        .assignment-row:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--gray-300);
            transform: translateY(-2px);
        }

        .assignment-row:last-child {
            margin-bottom: 0;
        }

        .assignment-row .form-control,
        .assignment-row .form-select {
            margin-bottom: 0;
        }

        .assignment-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        /* Dashboard Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background-color: white;
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
            display: flex;
            flex-direction: column;
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
        }

        .stat-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            border-radius: var(--radius-full);
            margin-bottom: 1rem;
            font-size: 1.25rem;
        }

        .stat-icon.primary {
            background-color: var(--primary-100);
            color: var(--primary-600);
        }

        .stat-icon.success {
            background-color: var(--success-100);
            color: var(--success-600);
        }

        .stat-icon.warning {
            background-color: var(--warning-100);
            color: var(--warning-600);
        }

        .stat-icon.info {
            background-color: var(--info-100);
            color: var(--info-600);
        }

        .stat-title {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-500);
            margin-bottom: 0.25rem;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
        }

        .stat-subtitle {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--gray-200);
            margin-bottom: 1.5rem;
        }

        .tab-item {
            padding: 0.75rem 1.25rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-600);
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tab-item:hover {
            color: var(--primary-600);
        }

        .tab-item.active {
            color: var(--primary-600);
            border-bottom-color: var(--primary-600);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Toast Notifications */
        #toast-container {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            z-index: var(--z-toast);
        }

        .toast {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            max-width: 400px;
            padding: 1rem 1.25rem;
            margin-top: 0.75rem;
            background-color: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            animation: slideInUp 0.3s ease forwards;
            border-left: 4px solid var(--primary-500);
        }

        .toast-success {
            border-left-color: var(--success-500);
        }

        .toast-error {
            border-left-color: var(--danger-500);
        }

        .toast-warning {
            border-left-color: var(--warning-500);
        }

        .toast-icon {
            font-size: 1.25rem;
            color: var(--primary-500);
        }

        .toast-success .toast-icon {
            color: var(--success-500);
        }

        .toast-error .toast-icon {
            color: var(--danger-500);
        }

        .toast-warning .toast-icon {
            color: var(--warning-500);
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 500;
            margin-bottom: 0.25rem;
            color: var(--gray-900);
        }

        .toast-message {
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        /* Loading State */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: var(--z-modal);
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid rgba(37, 99, 179, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-500);
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 1rem;
        }

        .loading-text {
            font-size: 1rem;
            font-weight: 500;
            color: var(--gray-700);
        }

        /* Modal */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: var(--z-modal);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-backdrop.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-dialog {
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            background-color: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }

        .modal-backdrop.show .modal-dialog {
            transform: translateY(0);
        }

        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--gray-500);
            font-size: 1.25rem;
            cursor: pointer;
            transition: color 0.15s ease;
        }

        .modal-close:hover {
            color: var(--gray-700);
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            max-height: calc(90vh - 132px);
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        /* Reports */
        .report-filter {
            background-color: white;
            padding: 1.25rem;
            border-radius: var(--radius-lg);
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
        }

        .report-controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .report-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: var(--gray-800);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .report-title i {
            color: var(--primary-500);
        }

        .report-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .summary-item {
            background-color: white;
            padding: 1rem;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
        }

        .summary-label {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-bottom: 0.25rem;
        }

        .summary-value {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        /* Chart containers */
        .chart-container {
            background-color: white;
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
            margin-bottom: 1.5rem;
            height: 300px;
        }

        /* Animations */
        @keyframes slideInUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Utility Classes */
        .d-flex {
            display: flex;
        }

        .flex-column {
            flex-direction: column;
        }

        .align-items-center {
            align-items: center;
        }

        .justify-content-between {
            justify-content: space-between;
        }

        .justify-content-center {
            justify-content: center;
        }

        .justify-content-end {
            justify-content: flex-end;
        }

        .flex-wrap {
            flex-wrap: wrap;
        }

        .gap-1 {
            gap: 0.25rem;
        }

        .gap-2 {
            gap: 0.5rem;
        }

        .gap-3 {
            gap: 0.75rem;
        }

        .gap-4 {
            gap: 1rem;
        }

        .gap-5 {
            gap: 1.25rem;
        }

        .gap-6 {
            gap: 1.5rem;
        }

        .mt-1 {
            margin-top: 0.25rem;
        }

        .mt-2 {
            margin-top: 0.5rem;
        }

        .mt-3 {
            margin-top: 0.75rem;
        }

        .mt-4 {
            margin-top: 1rem;
        }

        .mb-1 {
            margin-bottom: 0.25rem;
        }

        .mb-2 {
            margin-bottom: 0.5rem;
        }

        .mb-3 {
            margin-bottom: 0.75rem;
        }

        .mb-4 {
            margin-bottom: 1rem;
        }

        .mb-5 {
            margin-bottom: 1.25rem;
        }

        .mb-6 {
            margin-bottom: 1.5rem;
        }

        .ml-auto {
            margin-left: auto;
        }

        .p-0 {
            padding: 0;
        }

        .p-2 {
            padding: 0.5rem;
        }

        .p-3 {
            padding: 0.75rem;
        }

        .p-4 {
            padding: 1rem;
        }

        .text-sm {
            font-size: 0.875rem;
        }

        .text-xs {
            font-size: 0.75rem;
        }

        .text-right {
            text-align: right;
        }

        .text-center {
            text-align: center;
        }

        .fw-bold {
            font-weight: 600;
        }

        .fw-medium {
            font-weight: 500;
        }

        .text-muted {
            color: var(--gray-500);
        }

        .text-primary {
            color: var(--primary-600);
        }

        .text-success {
            color: var(--success-600);
        }

        .text-danger {
            color: var(--danger-600);
        }

        .text-warning {
            color: var(--warning-600);
        }

        .w-100 {
            width: 100%;
        }

        .h-100 {
            height: 100%;
        }

        .overflow-hidden {
            overflow: hidden;
        }

        .position-relative {
            position: relative;
        }

        .cursor-pointer {
            cursor: pointer;
        }

        .border-bottom {
            border-bottom: 1px solid var(--gray-200);
        }

        /* Responsive styles */
        @media (max-width: 1024px) {
            .app-sidebar {
                width: 240px;
            }

            .app-main {
                margin-left: 240px;
            }

            .assignment-row {
                grid-template-columns: 1fr 1fr 1fr;
                grid-template-rows: auto auto;
            }

            .assignment-row>*:nth-child(1),
            .assignment-row>*:nth-child(2),
            .assignment-row>*:nth-child(3) {
                grid-row: 1;
            }

            .assignment-row>*:nth-child(4),
            .assignment-row>*:nth-child(5),
            .assignment-row>*:nth-child(6) {
                grid-row: 2;
            }
        }

        @media (max-width: 768px) {
            .app-sidebar {
                width: 100%;
                position: fixed;
                top: 0;
                left: 0;
                bottom: auto;
                height: 100vh;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .app-sidebar.show {
                transform: translateX(0);
            }

            .app-main {
                margin-left: 0;
            }

            .mobile-menu-toggle {
                display: block;
            }

            .assignment-row {
                grid-template-columns: 1fr;
                grid-template-rows: repeat(6, auto);
                gap: 0.5rem;
            }

            .assignment-row>* {
                grid-column: 1;
            }

            .assignment-row>*:nth-child(1) {
                grid-row: 1;
            }

            .assignment-row>*:nth-child(2) {
                grid-row: 2;
            }

            .assignment-row>*:nth-child(3) {
                grid-row: 3;
            }

            .assignment-row>*:nth-child(4) {
                grid-row: 4;
            }

            .assignment-row>*:nth-child(5) {
                grid-row: 5;
            }

            .assignment-row>*:nth-child(6) {
                grid-row: 6;
            }

            .form-row {
                flex-direction: column;
            }

            .app-header {
                padding: 0.75rem 1rem;
            }

            .tabs {
                overflow-x: auto;
            }
        }

        /* Print Styles */
        @media print {
            .app-sidebar,
            .app-header,
            .btn,
            .btn-group,
            #toast-container,
            .report-filter,
            .no-print {
                display: none !important;
            }

            .app-main {
                margin-left: 0 !important;
            }

            .card {
                box-shadow: none !important;
                border: 1px solid #ddd !important;
            }

            .staff-list,
            #rows-container {
                max-height: none !important;
                overflow: visible !important;
            }

            body {
                background: white !important;
            }

            .assignment-row {
                break-inside: avoid;
                box-shadow: none !important;
                transform: none !important;
            }

            .table-responsive {
                overflow: visible;
                box-shadow: none;
            }

            .chart-container {
                break-inside: avoid;
                page-break-inside: avoid;
                box-shadow: none;
            }
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="app-sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <i class="fas fa-bus-alt" style="font-size: 1.5rem;"></i>
                    <span class="logo-text">Terminal El Roble</span>
                </div>
                <span class="sidebar-version">v5.0</span>
            </div>

            <div class="sidebar-content">
                <div class="nav-section">
                    <div class="nav-header">Módulos</div>
                    <ul class="nav-list">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-tab="dashboard">
                                <span class="nav-icon"><i class="fas fa-chart-pie"></i></span>
                                <span>Dashboard</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link active" data-tab="assignments">
                                <span class="nav-icon"><i class="fas fa-users-cog"></i></span>
                                <span>Asignador de Personal</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-tab="reports">
                                <span class="nav-icon"><i class="fas fa-file-alt"></i></span>
                                <span>Reportes</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-tab="history">
                                <span class="nav-icon"><i class="fas fa-history"></i></span>
                                <span>Historial</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <div class="nav-section">
                    <div class="nav-header">Configuración</div>
                    <div class="card mb-4">
                        <div class="card-body p-3">
                            <div class="form-group mb-3">
                                <label class="form-label">Fecha</label>
                                <input type="date" id="date" class="form-control">
                            </div>

                            <div class="form-group mb-3">
                                <label class="form-label">Bloque</label>
                                <div class="btn-group w-100">
                                    <button class="btn" id="tabDia">DÍA</button>
                                    <button class="btn btn-primary active" id="tabNoche">NOCHE</button>
                                </div>
                                <select id="block" class="form-select" style="display: none;">
                                    <option value="DIA">Día</option>
                                    <option value="NOCHE" selected>Noche</option>
                                </select>
                            </div>

                            <div class="form-group mb-3">
                                <label class="form-label">Filtro disponibilidad</label>
                                <select id="availabilityFilter" class="form-select">
                                    <option value="all">Todos</option>
                                    <option value="available">Solo disponibles</option>
                                    <option value="off">Libres/ausentes</option>
                                </select>
                            </div>

                            <div class="form-group mb-4">
                                <label class="form-label">Buscar personal</label>
                                <div class="search-input">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="searchStaff" class="form-control"
                                        placeholder="Nombre del trabajador...">
                                </div>
                            </div>

                            <div class="d-flex gap-2 flex-wrap">
                                <button class="btn btn-primary" id="btnReloadStaff" title="Cargar personal">
                                    <i class="fas fa-sync-alt"></i> Cargar
                                </button>
                                <button class="btn btn-outline" id="btnSelectAll" title="Seleccionar todo">
                                    <i class="fas fa-check-square"></i> Seleccionar
                                </button>
                                <button class="btn btn-outline" id="btnClear" title="Limpiar selección">
                                    <i class="fas fa-times"></i> Limpiar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="sidebar-footer">
                <div class="connection-status">
                    <div class="status-dot" id="sb-status-dot"></div>
                    <span id="sb-status-text">Conectando...</span>
                </div>
                <div>
                    <span class="badge badge-primary">
                        <i class="fas fa-database"></i> Supabase
                    </span>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="app-main">
            <header class="app-header">
                <div class="d-flex align-items-center gap-3">
                    <button class="btn btn-icon btn-sm mobile-menu-toggle" id="toggleSidebar" title="Menú">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="app-title">Asignador de Personal</h1>
                    <div class="badge badge-gray" id="staffCountBadge">0 seleccionados</div>
                </div>

                <div class="d-flex gap-2">
                    <span class="badge badge-primary" id="currentBlock">NOCHE</span>
                    <span class="badge badge-gray" id="currentDate">10/08/2025</span>
                </div>
            </header>

            <div class="app-content">
                <!-- Dashboard Tab -->
                <div class="tab-content" id="dashboard-tab">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon primary">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-title">Personal Total</div>
                            <div class="stat-value" id="stat-total-staff">26</div>
                            <div class="stat-subtitle"><span id="stat-staff-day">15</span> Día | <span id="stat-staff-night">11</span> Noche</div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon success">
                                <i class="fas fa-tasks"></i>
                            </div>
                            <div class="stat-title">Asignaciones Hoy</div>
                            <div class="stat-value" id="stat-assignments-today">0</div>
                            <div class="stat-subtitle">Bloque actual: <span id="stat-current-block">Noche</span></div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon warning">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="stat-title">Islas Cubiertas</div>
                            <div class="stat-value" id="stat-islands-covered">0/6</div>
                            <div class="stat-subtitle" id="stat-uncovered-islands">Todas las islas pendientes</div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon info">
                                <i class="fas fa-calendar-check"></i>
                            </div>
                            <div class="stat-title">Última Actualización</div>
                            <div class="stat-value" id="stat-last-update">--</div>
                            <div class="stat-subtitle" id="stat-update-user">Sin registros</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-chart-pie"></i> Distribución por Islas
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="chart-islands" class="chart-container"></div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-chart-bar"></i> Asignaciones por Día
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="chart-assignments" class="chart-container"></div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-clipboard-list"></i> Asignaciones Recientes
                            </div>
                            <button class="btn btn-sm btn-outline" id="btnViewAllAssignments">
                                Ver todas <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table" id="recent-assignments-table">
                                    <thead>
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Bloque</th>
                                            <th>Personal</th>
                                            <th>Asignación</th>
                                            <th>Isla</th>
                                            <th>Colación</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="6" class="text-center">Cargando datos recientes...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Assignments Tab -->
                <div class="tab-content active" id="assignments-tab">
                    <div class="grid grid-cols-3">
                        <!-- Staff List -->
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">
                                        <i class="fas fa-users"></i> Personal
                                    </div>
                                    <div class="card-subtitle">Seleccione el personal a asignar</div>
                                </div>
                                <div class="badge badge-primary" id="blockStaffCount">0 disponibles</div>
                            </div>
                            <div class="card-body">
                                <div id="staffList" class="staff-list">
                                    <div class="empty-state">
                                        <div class="empty-state-icon">
                                            <i class="fas fa-users"></i>
                                        </div>
                                        <div class="empty-state-title">Sin datos</div>
                                        <div class="empty-state-description">Presione "Cargar personal" para comenzar</div>
                                        <button class="btn btn-primary" id="btnReloadStaffEmpty">
                                            <i class="fas fa-sync-alt"></i> Cargar personal
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Assignments -->
                        <div class="card" style="grid-column: span 2;">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">
                                        <i class="fas fa-tasks"></i> Asignaciones
                                    </div>
                                    <div class="card-subtitle">Tareas, islas y colaciones</div>
                                </div>
                                <div class="badge badge-gray" id="assignmentCount">0 asignaciones</div>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-4 flex-wrap gap-3">
                                    <div class="d-flex gap-2 flex-wrap">
                                        <button class="btn btn-primary" id="btnAddRows">
                                            <i class="fas fa-user-plus"></i> Agregar seleccionados
                                        </button>
                                        <button class="btn btn-outline" id="btnAddEmpty">
                                            <i class="fas fa-plus"></i> Fila vacía
                                        </button>
                                        <button class="btn btn-outline" id="btnAutoIslas">
                                            <i class="fas fa-random"></i> Auto-islas
                                        </button>
                                    </div>

                                    <div class="d-flex gap-2 flex-wrap">
                                        <button class="btn btn-danger" id="btnClearRows">
                                            <i class="fas fa-trash-alt"></i> Vaciar tabla
                                        </button>
                                        <button class="btn btn-outline" id="btnExportCsv">
                                            <i class="fas fa-file-csv"></i> CSV
                                        </button>
                                    </div>
                                </div>

                                <div class="table-responsive mb-3">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th width="20%">Nombre</th>
                                                <th width="25%">Asignaciones</th>
                                                <th width="15%">Isla</th>
                                                <th width="12%">Inicio colación</th>
                                                <th width="12%">Fin colación</th>
                                                <th width="16%">Acciones</th>
                                            </tr>
                                        </thead>
                                    </table>
                                </div>

                                <div id="rows-container">
                                    <div id="rows">
                                        <div class="empty-state">
                                            <div class="empty-state-icon">
                                                <i class="fas fa-clipboard-list"></i>
                                            </div>
                                            <div class="empty-state-title">Sin asignaciones</div>
                                            <div class="empty-state-description">Seleccione personal y use "Agregar
                                                seleccionados" para comenzar</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-end mt-4 gap-3">
                                    <button class="btn btn-success" id="btnSave">
                                        <i class="fas fa-save"></i> Guardar asignaciones
                                    </button>
                                    <div class="btn-group">
                                        <button class="btn btn-outline-primary" id="btnPdfMaster">
                                            <i class="fas fa-file-pdf"></i> PDF general
                                        </button>
                                        <button class="btn btn-outline-primary" id="btnPdfIndividuals">
                                            <i class="fas fa-file-pdf"></i> PDFs individuales
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reports Tab -->
                <div class="tab-content" id="reports-tab">
                    <div class="report-filter">
                        <div class="report-title">
                            <i class="fas fa-filter"></i> Filtros de reporte
                        </div>
                        <div class="grid grid-cols-4 mb-4">
                            <div class="form-group">
                                <label class="form-label">Fecha inicio</label>
                                <input type="date" id="reportStartDate" class="form-control">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Fecha fin</label>
                                <input type="date" id="reportEndDate" class="form-control">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Bloque</label>
                                <select id="reportBlock" class="form-select">
                                    <option value="all">Todos</option>
                                    <option value="DIA">Día</option>
                                    <option value="NOCHE">Noche</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Personal</label>
                                <select id="reportStaff" class="form-select">
                                    <option value="all">Todos</option>
                                </select>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end">
                            <button class="btn btn-primary" id="btnGenerateReport">
                                <i class="fas fa-search"></i> Generar reporte
                            </button>
                        </div>
                    </div>

                    <div id="reportResults">
                        <div class="report-title">
                            <i class="fas fa-chart-line"></i> Resultados del reporte
                            <div class="badge badge-gray" id="reportDateRange">10/08/2025 - 10/08/2025</div>
                        </div>

                        <div class="report-summary mb-4">
                            <div class="summary-item">
                                <div class="summary-label">Total asignaciones</div>
                                <div class="summary-value" id="report-total-assignments">0</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Días cubiertos</div>
                                <div class="summary-value" id="report-days-covered">0</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Personal asignado</div>
                                <div class="summary-value" id="report-staff-assigned">0</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Islas asignadas</div>
                                <div class="summary-value" id="report-islands-assigned">0</div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 mb-4">
                            <div class="chart-container">
                                <canvas id="report-chart-tasks"></canvas>
                            </div>
                            <div class="chart-container">
                                <canvas id="report-chart-islands"></canvas>
                            </div>
                        </div>

                        <div class="card mb-4">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-table"></i> Detalle de asignaciones
                                </div>
                                <button class="btn btn-sm btn-outline" id="btnExportReportCsv">
                                    <i class="fas fa-download"></i> Exportar CSV
                                </button>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table" id="report-detail-table">
                                        <thead>
                                            <tr>
                                                <th>Fecha</th>
                                                <th>Bloque</th>
                                                <th>Personal</th>
                                                <th>Asignación</th>
                                                <th>Isla</th>
                                                <th>Colación</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td colspan="6" class="text-center">Use los filtros para generar un reporte</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- History Tab -->
                <div class="tab-content" id="history-tab">
                    <div class="card mb-4">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-history"></i> Historial de asignaciones
                            </div>
                            <div class="d-flex gap-2">
                                <div class="form-group mb-0">
                                    <input type="month" id="historyMonth" class="form-control">
                                </div>
                                <button class="btn btn-outline" id="btnLoadHistory">
                                    <i class="fas fa-sync-alt"></i> Cargar
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table" id="history-table">
                                    <thead>
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Bloque</th>
                                            <th>Asignaciones</th>
                                            <th>Islas</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="5" class="text-center">Seleccione un mes para ver el historial</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div class="modal-backdrop" id="detailModal">
        <div class="modal-dialog">
            <div class="modal-header">
                <div class="modal-title">Detalle de asignaciones</div>
                <button class="modal-close" id="closeDetailModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between mb-3">
                    <div>
                        <div class="text-sm text-muted">Fecha</div>
                        <div class="fw-bold" id="modal-date">--/--/----</div>
                    </div>
                    <div>
                        <div class="text-sm text-muted">Bloque</div>
                        <div class="fw-bold" id="modal-block">--</div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table" id="modal-assignments-table">
                        <thead>
                            <tr>
                                <th>Personal</th>
                                <th>Asignación</th>
                                <th>Isla</th>
                                <th>Colación</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="4" class="text-center">Cargando detalles...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline-primary" id="btnModalExportPdf">
                    <i class="fas fa-file-pdf"></i> Exportar PDF
                </button>
                <button class="btn btn-outline" id="btnCloseDetailModal">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Libs: Supabase, dayjs, jsPDF + AutoTable + Sortable + Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/es.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <script>
        // =========================
        // 🔧 CONFIGURACIÓN SUPABASE
        // =========================
        window.SUPABASE_CONFIG = {
            url: "https://tcmtxvuucjttngcazgff.supabase.co",
            anonKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRjbXR4dnV1Y2p0dG5nY2F6Z2ZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA3MjUwMDEsImV4cCI6MjA1NjMwMTAwMX0.2WcIjMUEhSM6j9kYpbsYArQocZdHx86k7wXk-NyjIs0"
        };

        // ===== PERSONAL CON BLOQUE (DÍA / NOCHE) =====
        const RAW_STAFF = [
            // Día
            { n: "PAMELA ANDRADES", b: "DIA" },
            { n: "DANIELA SOLORZA", b: "DIA" },
            { n: "SILVIA GONZALEZ", b: "DIA" },
            { n: "SILVIA VILLALOBOS", b: "DIA" },
            { n: "SCARLETH VILLARROEL", b: "DIA" },
            { n: "JACKSON JOSEPH", b: "DIA" },
            { n: "GALINDO SAEZ", b: "DIA" },
            { n: "MELANIE FORLIVESI", b: "DIA" },
            { n: "CLAUDIA NUÑEZ", b: "DIA" },
            { n: "CRISTIAN MALDONADO", b: "DIA" },
            { n: "FABIAN FERNANDEZ", b: "DIA" },
            // Noche
            { n: "RODOLFO ULLOA", b: "NOCHE" },
            { n: "RICARDO MEDINA", b: "NOCHE" },
            { n: "RODRIGO CORTEZ", b: "NOCHE" },
            { n: "ROSA SMART", b: "NOCHE" },
            { n: "MARIA LAZCANO", b: "NOCHE" },
            { n: "ISAAC MAGUIÑA", b: "NOCHE" },
            { n: "NELSON RODRIGUEZ", b: "NOCHE" },
            { n: "AXIS MAURICE", b: "NOCHE" },
            { n: "VICTOR SANCHEZ", b: "NOCHE" },
            { n: "VITEL DESROSIERS", b: "NOCHE" },
            { n: "VERONICA ORTIZ", b: "NOCHE" }
        ];

        // === CATÁLOGO DE ASIGNACIONES (multi) ===
        const TASKS = [
            "CORPORATIVO",
            "SALA DE CAPACITACION",
            "ISLA DE OPERACIONES",
            "TALLER",
            "BARRIDO",
            "BARRIDO Y MOPEO",
            "FULL (BARRIDO, MOPEO, GRAFFITI, GOMAS, FIERROS, CABINA)",
            "CABINA",
            "BANDEJON",
            "ESTACIONAMIENTOS",
            "FRONTIS TERMINAL",
            "BARRIDO PATIO"
        ];

        // === ISLAS ACTUALIZADAS ===
        const ISLANDS = [
            "",
            "Isla 1",
            "Isla 2",
            "Isla 1 Y 2",
            "Isla 3",
            "Isla 4",
            "Isla 5",
            "TODO EL PATIO",
            "Frente Taller"
        ];

        // ===== Estado global de la aplicación =====
        const AppState = {
            supabase: null,
            staff: [], // {id,name,available,role,block}
            selectedStaff: new Set(),
            islands: ISLANDS,
            rows: [], // {name, tasks[], island, lunchStart,lunchEnd}
            ui: { 
                sortable: null,
                activeTab: 'assignments'
            },
            // Datos para reportes y dashboard
            stats: {
                recentAssignments: [],
                totalAssignments: 0,
                assignmentsByDay: {},
                islandDistribution: {},
                lastUpdate: null
            },
            charts: {}
        };

        // ===== DOM Helpers =====
        const el = sel => document.querySelector(sel);
        const all = sel => document.querySelectorAll(sel);

        // Actualizar contador de personal seleccionado
        const updateSelectedCountBadge = () => {
            const count = AppState.selectedStaff.size;
            el('#staffCountBadge').textContent = `${count} seleccionado${count !== 1 ? 's' : ''}`;
        };

        // Actualizar contador de asignaciones
        const updateAssignmentCountBadge = () => {
            const count = AppState.rows.length;
            el('#assignmentCount').textContent = `${count} asignación${count !== 1 ? 'es' : ''}`;
        };

        // Actualizar contador de personal disponible por bloque
        const updateBlockStaffCountBadge = () => {
            const block = currentBlock();
            const count = AppState.staff.filter(s => s.block === block).length;
            el('#blockStaffCount').textContent = `${count} disponible${count !== 1 ? 's' : ''}`;
        };

        // Mostrar notificaciones (toast)
        function showToast(title, message, type = 'info') {
            const container = el('#toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;

            let icon = 'info-circle';
            if (type === 'success') icon = 'check-circle';
            if (type === 'error') icon = 'exclamation-circle';
            if (type === 'warning') icon = 'exclamation-triangle';

            toast.innerHTML = `
                <div class="toast-icon">
                    <i class="fas fa-${icon}"></i>
                </div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
            `;

            container.appendChild(toast);

            // Quitar automáticamente después de 4 segundos
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease forwards';
                setTimeout(() => {
                    container.removeChild(toast);
                }, 300);
            }, 4000);
        }

        // Mostrar overlay de carga
        function showLoading(message = 'Cargando...') {
            const existingOverlay = document.querySelector('.loading-overlay');
            if (existingOverlay) return;

            const overlay = document.createElement('div');
            overlay.className = 'loading-overlay';
            overlay.innerHTML = `
                <div class="spinner"></div>
                <div class="loading-text">${message}</div>
            `;
            document.body.appendChild(overlay);
        }

        // Ocultar overlay de carga
        function hideLoading() {
            const overlay = document.querySelector('.loading-overlay');
            if (overlay) {
                document.body.removeChild(overlay);
            }
        }

        // ===== Utilidades para formato de nombres =====
        function toNombreApellido(raw) {
            let s = String(raw).replace(/\s+/g, ' ').trim();
            if (s.includes(',')) {
                const [ap, no] = s.split(',').map(x => x.trim());
                const apellido = ap.split(' ')[0];
                const nombre = no.split(' ')[0];
                return cap(nombre + " " + apellido);
            } else {
                const parts = s.split(' ');
                if (parts.length === 1) return cap(parts[0]);
                const nombre = parts[parts.length - 1];
                const apellido = parts[0];
                return cap(nombre + " " + apellido);
            }
        }

        function cap(str) {
            return str.toLowerCase().replace(/(^|\s|\b)([a-záéíóúñü])/g, (m, p1, p2) => p1 + p2.toUpperCase());
        }

        // ===== Inicialización =====
        dayjs.locale('es');

        function initSupabase() {
            const { url, anonKey } = window.SUPABASE_CONFIG || {};
            if (!url || !anonKey) {
                el('#sb-status-dot').classList.add('error');
                el('#sb-status-text').textContent = 'Sin configuración';
                return null;
            }

            if (!window.supabase || typeof window.supabase.createClient !== 'function') {
                el('#sb-status-dot').classList.add('error');
                el('#sb-status-text').textContent = 'CDN no cargó';
                return null;
            }

            try {
                const client = window.supabase.createClient(url, anonKey);
                el('#sb-status-text').textContent = 'Conectado';
                return client;
            } catch (error) {
                el('#sb-status-dot').classList.add('error');
                el('#sb-status-text').textContent = 'Error de conexión';
                console.error('Error al conectar con Supabase:', error);
                return null;
            }
        }

        const todayISO = () => dayjs().format('YYYY-MM-DD');
        const formatDate = date => dayjs(date).format('DD/MM/YYYY');

        // ===== Staff =====
        function buildLocalStaff() {
            return RAW_STAFF.map(x => ({
                id: crypto.randomUUID(),
                name: toNombreApellido(x.n),
                available: true,
                role: 'Cleaner',
                block: x.b
            })).sort((a, b) => a.name.localeCompare(b.name));
        }

        async function loadStaff() {
            try {
                showLoading('Cargando personal...');
                
                // Si quieres usar Supabase, descomenta y mapea campos (requiere columnas block o default_shift)
                // Por ahora cargamos local con separación Día/Noche
                AppState.staff = buildLocalStaff();
                renderStaffList();
                updateBlockStaffCountBadge();
                
                // Actualizar estadísticas del dashboard
                updateDashboardStats();
                
                // Llenar selector de personal en reportes
                populateStaffSelect();
                
                hideLoading();
                showToast('Personal cargado', 'Personal cargado correctamente', 'success');
            } catch (error) {
                hideLoading();
                console.error('Error al cargar personal:', error);
                showToast('Error', 'No se pudo cargar el personal', 'error');
            }
        }

        // ===== UI Staff (filtrado por Bloque y búsqueda) =====
        function currentBlock() {
            return el('#block').value;
        }

        function renderStaffList() {
            const container = el('#staffList');

            if (!AppState.staff.length) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="empty-state-title">Sin personal</div>
                        <div class="empty-state-description">No se encontró personal en el sistema</div>
                        <button class="btn btn-primary" id="btnReloadStaffEmpty">
                            <i class="fas fa-sync-alt"></i> Cargar personal
                        </button>
                    </div>
                `;
                el('#btnReloadStaffEmpty')?.addEventListener('click', loadStaff);
                return;
            }

            container.innerHTML = '';

            const searchQuery = el('#searchStaff').value.trim().toLowerCase();
            const availabilityMode = el('#availabilityFilter').value;
            const block = currentBlock();

            const filteredStaff = AppState.staff.filter(staff => {
                if (staff.block !== block) return false;
                if (searchQuery && !staff.name.toLowerCase().includes(searchQuery)) return false;
                if (availabilityMode === 'available' && !staff.available) return false;
                if (availabilityMode === 'off' && staff.available) return false;
                return true;
            });

            if (filteredStaff.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-filter"></i>
                        </div>
                        <div class="empty-state-title">Sin resultados</div>
                        <div class="empty-state-description">No hay personal que coincida con los filtros aplicados</div>
                    </div>
                `;
                return;
            }

            filteredStaff.forEach(staff => {
                const staffItem = document.createElement('div');
                staffItem.className = 'staff-item';

                const isChecked = AppState.selectedStaff.has(staff.id);

                staffItem.innerHTML = `
                    <input type="checkbox" class="staff-checkbox" id="staff-${staff.id}" ${isChecked ? 'checked' : ''}>
                    <label class="staff-info" for="staff-${staff.id}">${staff.name}</label>
                `;

                container.appendChild(staffItem);

                // Add event listener to checkbox
                staffItem.querySelector('input[type="checkbox"]').addEventListener('change', e => {
                    if (e.target.checked) {
                        AppState.selectedStaff.add(staff.id);
                    } else {
                        AppState.selectedStaff.delete(staff.id);
                    }
                    updateSelectedCountBadge();
                });
            });

            updateSelectedCountBadge();
        }

        // ===== Filas de asignación =====
        function createMultiTaskSelect(selectedTasks = []) {
            const options = TASKS.map(task => {
                const selected = selectedTasks.includes(task) ? 'selected' : '';
                return `<option value="${task}" ${selected}>${task}</option>`;
            }).join('');

            return `<select data-k="tasks" multiple class="form-select">${options}</select>`;
        }

        function createIslandSelect(selectedIsland = '') {
            return `
                <select data-k="island" class="form-select">
                    ${ISLANDS.map(island => {
                        const selected = island === selectedIsland ? 'selected' : '';
                        return `<option value="${island}" ${selected}>${island || '— Sin isla —'}</option>`;
                    }).join('')}
                </select>
            `;
        }

        function rowTemplate(data = {}) {
            const id = data._id || crypto.randomUUID();
            const staffName = data.name || '';
            const lunchStart = data.lunchStart || '';
            const lunchEnd = data.lunchEnd || '';
            const island = data.island || '';
            const tasks = Array.isArray(data.tasks) ? data.tasks : [];

            return `
                <div class="assignment-row" data-row="${id}">
                    <input data-k="name" class="form-control" placeholder="Nombre" value="${staffName}">
                    ${createMultiTaskSelect(tasks)}
                    ${createIslandSelect(island)}
                    <div class="time-input-container">
                        <input data-k="lunchStart" type="time" class="form-control time-input" placeholder="13:00" value="${lunchStart}">
                        <span class="time-input-icon"><i class="fas fa-clock"></i></span>
                    </div>
                    <div class="time-input-container">
                        <input data-k="lunchEnd" type="time" class="form-control time-input" placeholder="14:00" value="${lunchEnd}">
                        <span class="time-input-icon"><i class="fas fa-clock"></i></span>
                    </div>
                    <div class="assignment-actions">
                        <button class="btn btn-sm btn-outline" data-act="col" title="Asignar colación">
                            <i class="fas fa-clock"></i>
                        </button>
                        <button class="btn btn-sm btn-outline" data-act="copy" title="Duplicar">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" data-act="del" title="Eliminar">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        function renderRows() {
            const container = el('#rows');

            if (!AppState.rows.length) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                        <div class="empty-state-title">Sin asignaciones</div>
                        <div class="empty-state-description">Seleccione personal y use "Agregar seleccionados" para comenzar</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = AppState.rows.map(row => rowTemplate(row)).join('');
            updateAssignmentCountBadge();

            // Action buttons
            container.querySelectorAll('[data-act="del"]').forEach(button => {
                button.addEventListener('click', e => {
                    const row = e.target.closest('[data-row]');
                    const id = row.getAttribute('data-row');
                    AppState.rows = AppState.rows.filter(r => r._id !== id);
                    renderRows();
                });
            });

            container.querySelectorAll('[data-act="copy"]').forEach(button => {
                button.addEventListener('click', e => {
                    const row = e.target.closest('[data-row]');
                    addRow(readRow(row));
                    showToast('Fila duplicada', 'La fila ha sido duplicada correctamente', 'success');
                });
            });

            container.querySelectorAll('[data-act="col"]').forEach(button => {
                button.addEventListener('click', e => {
                    const block = currentBlock();
                    const row = e.target.closest('[data-row]');
                    const startInput = row.querySelector('[data-k="lunchStart"]');
                    const endInput = row.querySelector('[data-k="lunchEnd"]');

                    if (block === 'DIA') {
                        // Verificar qué horas ya están usadas para distribuir mejor
                        const usedTimes = Array.from(document.querySelectorAll('[data-k="lunchStart"]'))
                            .map(input => input.value)
                            .filter(Boolean);

                        // Contar cuántas veces aparece cada hora
                        const countMap = {};
                        usedTimes.forEach(time => {
                            countMap[time] = (countMap[time] || 0) + 1;
                        });

                        // Horarios de colación para bloque día (13:00-14:00, 14:00-15:00)
                        // Asigna el horario menos usado para balancear
                        const timeslots = [
                            { start: '13:00', end: '14:00' },
                            { start: '14:00', end: '15:00' }
                        ];

                        // Elegir el timeslot menos usado
                        const slot = timeslots.sort((a, b) =>
                            (countMap[a.start] || 0) - (countMap[b.start] || 0)
                        )[0];

                        startInput.value = slot.start;
                        endInput.value = slot.end;
                    } else {
                        // Horario fijo para bloque noche
                        startInput.value = '23:00';
                        endInput.value = '00:00';
                    }

                    // Actualizar el estado después de asignar la colación
                    AppState.rows = Array.from(document.querySelectorAll('[data-row]')).map(readRow);
                    showToast('Colación asignada', 'Horario de colación asignado automáticamente', 'success');
                });
            });

            // Sortable (arrastrar y soltar filas)
            if (AppState.ui?.sortable) {
                AppState.ui.sortable.destroy();
            }

            AppState.ui = AppState.ui || {};
            AppState.ui.sortable = new Sortable(container, {
                animation: 150,
                handle: '.assignment-row',
                ghostClass: 'assignment-row-ghost',
                onEnd: () => {
                    AppState.rows = Array.from(container.querySelectorAll('[data-row]')).map(readRow);
                }
            });
        }

        function addRow(obj = {}) {
            const row = Object.assign({
                _id: crypto.randomUUID(),
                name: '',
                tasks: [],
                island: '',
                lunchStart: '',
                lunchEnd: ''
            }, obj);

            AppState.rows.push(row);
            renderRows();
        }

        function readRow(node) {
            const getValue = key => node.querySelector(`[data-k="${key}"]`).value;

            const tasksSelect = node.querySelector('[data-k="tasks"]');
            const selectedTasks = Array.from(tasksSelect.selectedOptions).map(option => option.value);

            return {
                _id: node.getAttribute('data-row') || crypto.randomUUID(),
                name: getValue('name').trim(),
                tasks: selectedTasks,
                island: getValue('island'),
                lunchStart: getValue('lunchStart'),
                lunchEnd: getValue('lunchEnd')
            };
        }

        function collectRows() {
            const rows = Array.from(document.querySelectorAll('[data-row]')).map(readRow);
            const errors = [];

            rows.forEach((row, index) => {
                if (!row.name) {
                    errors.push(`Fila ${index + 1}: Falta nombre`);
                }

                if (!row.tasks.length) {
                    errors.push(`Fila ${index + 1}: Seleccione al menos una asignación`);
                }

                if (row.lunchStart && row.lunchEnd) {
                    // Validar formato de horas
                    const timeRegex = /^\d{2}:\d{2}$/;
                    if (!timeRegex.test(row.lunchStart) || !timeRegex.test(row.lunchEnd)) {
                        errors.push(`Fila ${index + 1}: Formato de hora inválido`);
                    } else {
                        // Validar que hora fin > hora inicio (excepto 23:00-00:00 para noche)
                        const convertToMinutes = time => {
                            const [hours, minutes] = time.split(':').map(Number);
                            return hours * 60 + minutes;
                        };

                        const startMinutes = convertToMinutes(row.lunchStart);
                        const endMinutes = convertToMinutes(row.lunchEnd);

                        const validRange = endMinutes > startMinutes ||
                            (row.lunchStart === '23:00' && row.lunchEnd === '00:00');

                        if (!validRange) {
                            errors.push(`Fila ${index + 1}: La hora de fin debe ser mayor que la de inicio`);
                        }
                    }
                } else if (row.lunchStart || row.lunchEnd) {
                    // Si hay una hora pero falta la otra
                    errors.push(`Fila ${index + 1}: Debe especificar ambas horas de colación`);
                }
            });

            return { rows, errors };
        }

        // ===== Guardar asignaciones =====
        async function saveAssignments() {
            if (!AppState.supabase) {
                showToast('Error', 'Sin conexión a Supabase', 'error');
                return;
            }

            const date = el('#date').value || todayISO();
            const block = currentBlock();
            const { rows, errors } = collectRows();

            if (errors.length) {
                showToast('Validación fallida', 'Hay errores en las asignaciones', 'error');
                console.error('Errores de validación:', errors);
                errors.forEach(error => {
                    showToast('Error', error, 'error');
                });
                return;
            }

            if (!rows.length) {
                showToast('Sin datos', 'No hay filas para guardar', 'warning');
                return;
            }

            try {
                showLoading('Guardando asignaciones...');

                // Eliminar registros existentes para la misma fecha y bloque
                console.log(`Eliminando asignaciones previas (${date}, ${block})...`);
                const { error: deleteError } = await AppState.supabase
                    .from('assignments')
                    .delete()
                    .eq('date', date)
                    .eq('block', block);

                if (deleteError) {
                    hideLoading();
                    throw new Error('Error al eliminar registros previos: ' + deleteError.message);
                }

                // Preparar los datos simplificados para Supabase
                const payload = [];
                for (const row of rows) {
                    // Asegurarnos que task nunca sea nulo o vacío
                    const taskValue = Array.isArray(row.tasks) && row.tasks.length > 0
                        ? row.tasks.join(' | ')
                        : 'Sin asignar';

                    payload.push({
                        date: date,
                        block: block,
                        staff_name: row.name || 'Sin nombre',
                        task: taskValue,
                        island: row.island || null,
                        lunch_start: row.lunchStart || null,
                        lunch_end: row.lunchEnd || null,
                        created_at: new Date().toISOString() // Timestamp para seguimiento
                    });
                }

                // Insertar registros uno por uno para mejor diagnóstico
                let savedCount = 0;
                let hasErrors = false;

                for (const item of payload) {
                    const { error: insertError } = await AppState.supabase
                        .from('assignments')
                        .insert([item]);

                    if (insertError) {
                        console.error(`Error al guardar fila:`, insertError);
                        hasErrors = true;
                    } else {
                        savedCount++;
                    }
                }

                hideLoading();

                if (hasErrors) {
                    if (savedCount > 0) {
                        showToast('Guardado parcial', `Se guardaron ${savedCount} de ${payload.length} asignaciones`, 'warning');
                    } else {
                        throw new Error('No se pudo guardar ninguna asignación');
                    }
                } else {
                    showToast('Guardado exitoso', `${savedCount} asignaciones guardadas en la base de datos`, 'success');
                    
                    // Actualizar datos del dashboard y reportes
                    loadRecentAssignments();
                    updateDashboardStats();
                }
            } catch (error) {
                hideLoading();
                console.error('Error al guardar asignaciones:', error);
                showToast('Error al guardar', error.message, 'error');
            }
        }

        // ===== PDF General =====
        async function makeMasterPdf() {
            try {
                showLoading('Generando PDF general...');
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    unit: 'mm',
                    format: 'a4',
                    orientation: 'landscape'
                });

                const date = el('#date').value || todayISO();
                const block = currentBlock();
                const { rows, errors } = collectRows();

                if (errors.length) {
                    hideLoading();
                    showToast('Validación fallida', 'Corrige los errores antes de generar el PDF', 'error');
                    return;
                }

                if (!rows.length) {
                    hideLoading();
                    showToast('Sin datos', 'No hay asignaciones para generar PDF', 'warning');
                    return;
                }

                // Header with background
                doc.setFillColor(15, 60, 110);
                doc.rect(0, 0, 297, 30, 'F');

                // Title
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(18);
                doc.text('Terminal El Roble - Asignaciones', 15, 15);

                // Subtitle
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                const dateFormatted = formatDate(date);
                doc.text(`Fecha: ${dateFormatted}   Bloque: ${block}   Registros: ${rows.length}`, 15, 23);

                // Table
                const tableColumn = ['#', 'Nombre', 'Asignaciones', 'Isla', 'Colación inicio', 'Colación fin'];
                const tableRows = rows.map((row, index) => [
                    index + 1,
                    row.name,
                    row.tasks.join(' / '),
                    row.island || '—',
                    row.lunchStart || '—',
                    row.lunchEnd || '—'
                ]);

                doc.autoTable({
                    head: [tableColumn],
                    body: tableRows,
                    startY: 40,
                    theme: 'grid',
                    styles: {
                        fontSize: 10,
                        cellPadding: 4,
                        lineColor: [222, 226, 230],
                        lineWidth: 0.1
                    },
                    headStyles: {
                        fillColor: [15, 60, 110],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold'
                    },
                    alternateRowStyles: {
                        fillColor: [240, 245, 255]
                    },
                    margin: { top: 40, left: 15, right: 15, bottom: 20 }
                });

                // Footer
                const pageCount = doc.internal.getNumberOfPages();
                doc.setFontSize(8);
                doc.setTextColor(100, 100, 100);

                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.text(`Página ${i} de ${pageCount} - Terminal El Roble`, 15, doc.internal.pageSize.height - 10);
                    doc.text(`Generado: ${new Date().toLocaleString()}`, doc.internal.pageSize.width - 15, doc.internal.pageSize.height - 10, { align: 'right' });
                }

                hideLoading();
                
                // Save the PDF
                doc.save(`Terminal_El_Roble_Asignaciones_${date}_${block}.pdf`);
                showToast('PDF generado', 'PDF general generado correctamente', 'success');
            } catch (error) {
                hideLoading();
                console.error('Error al generar PDF general:', error);
                showToast('Error', 'No se pudo generar el PDF', 'error');
            }
        }

        // ===== PDFs Individuales (Versión mejorada) =====
        async function makeIndividualPdfs() {
            try {
                const { jsPDF } = window.jspdf;
                const date = el('#date').value || todayISO();
                const block = currentBlock();
                const { rows, errors } = collectRows();

                if (errors.length) {
                    showToast('Validación fallida', 'Corrige los errores antes de generar los PDFs', 'error');
                    return;
                }

                if (!rows.length) {
                    showToast('Sin datos', 'No hay asignaciones para generar PDFs', 'warning');
                    return;
                }

                showLoading('Generando PDFs individuales...');

                const dateFormatted = formatDate(date);
                let pdfCount = 0;

                for (const row of rows) {
                    const doc = new jsPDF({
                        unit: 'mm',
                        format: 'a4',
                        orientation: 'portrait'
                    });

                    // Márgenes de página
                    const margin = 15;
                    const pageWidth = doc.internal.pageSize.width;
                    const pageHeight = doc.internal.pageSize.height;
                    const contentWidth = pageWidth - (margin * 2);

                    // Borde del documento
                    doc.setDrawColor(200, 210, 220);
                    doc.setLineWidth(0.5);
                    doc.rect(margin - 2, margin - 2, contentWidth + 4, pageHeight - (margin * 2) + 4);

                    // Cabecera
                    doc.setFillColor(15, 60, 110);
                    doc.rect(margin, margin, contentWidth, 15, 'F');

                    // Título
                    doc.setTextColor(255, 255, 255);
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(12);
                    doc.text('Terminal El Roble - Asignación Individual', margin + 5, margin + 10);

                    // Información básica
                    doc.setTextColor(100, 100, 100);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(9);
                    doc.text(`Fecha: ${dateFormatted}  |  Bloque: ${block}`, pageWidth - margin - 5, margin + 10, { align: 'right' });

                    // Datos del trabajador
                    const startY = margin + 25;

                    doc.setFillColor(240, 245, 250);
                    doc.rect(margin, startY, contentWidth, 15, 'F');

                    doc.setTextColor(15, 60, 110);
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(14);
                    doc.text(row.name, margin + 5, startY + 10);

                    // Información de asignación
                    const infoY = startY + 25;

                    // Datos con etiquetas en negrita
                    doc.setTextColor(50, 50, 50);
                    doc.setFontSize(10);

                    doc.setFont('helvetica', 'bold');
                    doc.text('Asignaciones:', margin, infoY);
                    doc.setFont('helvetica', 'normal');
                    doc.text(row.tasks.join(' / '), margin + 30, infoY);

                    doc.setFont('helvetica', 'bold');
                    doc.text('Isla:', margin, infoY + 8);
                    doc.setFont('helvetica', 'normal');
                    doc.text(row.island || '—', margin + 30, infoY + 8);

                    doc.setFont('helvetica', 'bold');
                    doc.text('Colación:', margin, infoY + 16);
                    doc.setFont('helvetica', 'normal');
                    doc.text(`${row.lunchStart || '—'} a ${row.lunchEnd || '—'}`, margin + 30, infoY + 16);

                    // Tabla de PPU
                    const tableY = infoY + 25;

                    // Encabezado de tabla
                    doc.setFillColor(20, 120, 70);
                    doc.rect(margin, tableY, contentWidth, 8, 'F');

                    doc.setTextColor(255, 255, 255);
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(9);
                    doc.text('N°', margin + 5, tableY + 5.5);
                    doc.text('PPU', margin + 15, tableY + 5.5);
                    doc.text('Observación', margin + 60, tableY + 5.5);

                    // Filas de la tabla (15 filas)
                    const rowHeight = 8;
                    doc.setDrawColor(200, 200, 200);
                    doc.setTextColor(70, 70, 70);
                    doc.setFont('helvetica', 'normal');

                    for (let i = 0; i < 15; i++) {
                        const y = tableY + 8 + (i * rowHeight);

                        // Alternar colores de fondo para las filas
                        if (i % 2 === 0) {
                            doc.setFillColor(245, 250, 245);
                            doc.rect(margin, y, contentWidth, rowHeight, 'F');
                        }

                        // Líneas horizontales
                        doc.line(margin, y, margin + contentWidth, y);

                        // Número de fila
                        doc.text(`${i + 1}`, margin + 5, y + 5.5);

                        // Líneas verticales
                        doc.line(margin + 10, y, margin + 10, y + rowHeight);
                        doc.line(margin + 50, y, margin + 50, y + rowHeight);
                    }

                    // Línea final
                    doc.line(margin, tableY + 8 + (15 * rowHeight), margin + contentWidth, tableY + 8 + (15 * rowHeight));

                    // Marco de la tabla
                    doc.rect(margin, tableY, contentWidth, 8 + (15 * rowHeight));

                    // Pie de página
                    const footerY = pageHeight - margin - 5;
                    doc.setFontSize(8);
                    doc.setTextColor(120, 120, 120);
                    doc.text(`Terminal El Roble | ${dateFormatted} | ${block}`, margin, footerY);
                    doc.text(`Generado: ${new Date().toLocaleString()}`, pageWidth - margin, footerY, { align: 'right' });

                    // Guardar el PDF
                    const sanitizedName = sanitizeFileName(row.name);
                    doc.save(`Terminal_El_Roble_${date}_${block}_${sanitizedName}.pdf`);
                    pdfCount++;
                }

                hideLoading();
                showToast('PDFs generados', `${pdfCount} PDFs individuales generados`, 'success');
            } catch (error) {
                hideLoading();
                console.error('Error al generar PDFs individuales:', error);
                showToast('Error', 'No se pudo generar los PDFs individuales', 'error');
            }
        }

        function sanitizeFileName(name) {
            return name.normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/[^a-zA-Z0-9-_ ]/g, '')
                .replace(/\s+/g, '_');
        }

        // ===== Extras =====
        function autoAssignIslands() {
            const rows = document.querySelectorAll('[data-row]');
            if (!rows.length) {
                showToast('Sin datos', 'No hay filas para asignar islas', 'warning');
                return;
            }

            const islandsToAssign = AppState.islands.filter(i => i); // Filter out empty option

            rows.forEach((row, index) => {
                const islandSelect = row.querySelector('[data-k="island"]');
                if (islandSelect) {
                    const islandIndex = index % islandsToAssign.length;
                    islandSelect.value = islandsToAssign[islandIndex];
                }
            });

            AppState.rows = Array.from(rows).map(readRow);
            showToast('Islas asignadas', 'Islas asignadas automáticamente en secuencia', 'success');
            
            // Actualizar conteo de islas en el dashboard
            updateIslandStats();
        }

        function exportCSV() {
            const { rows, errors } = collectRows();

            if (errors.length) {
                showToast('Validación fallida', 'Corrige los errores antes de exportar', 'error');
                return;
            }

            if (!rows.length) {
                showToast('Sin datos', 'No hay datos para exportar', 'warning');
                return;
            }

            const date = el('#date').value || todayISO();
            const block = currentBlock();

            const headers = ['Fecha', 'Bloque', 'Nombre', 'Asignaciones', 'Isla', 'ColacionInicio', 'ColacionFin'];

            const csvContent = [
                headers.join(','),
                ...rows.map(row => [
                    date,
                    block,
                    csvEscape(row.name),
                    csvEscape(row.tasks.join(' / ')),
                    csvEscape(row.island || ''),
                    row.lunchStart || '',
                    row.lunchEnd || ''
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Terminal_El_Roble_${date}_${block}.csv`;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showToast('CSV exportado', 'Archivo CSV exportado correctamente', 'success');
        }

        function csvEscape(str) {
            str = (str || '').toString().replace(/"/g, '""');
            return `"${str}"`;
        }

        // ===== Default Row para cada bloque =====
        function defaultRowForBlock(data = {}) {
            const block = currentBlock();

            if (block === 'DIA') {
                return Object.assign({
                    tasks: [],
                    island: '',
                    lunchStart: '13:00',
                    lunchEnd: '14:00'
                }, data);
            } else {
                return Object.assign({
                    tasks: [],
                    island: '',
                    lunchStart: '23:00',
                    lunchEnd: '00:00'
                }, data);
            }
        }

        // ===== Dashboard y Reportes =====
        
        // Cargar asignaciones recientes para el dashboard
        async function loadRecentAssignments() {
            if (!AppState.supabase) return;
            
            try {
                const { data, error } = await AppState.supabase
                    .from('assignments')
                    .select('*')
                    .order('date', { ascending: false })
                    .order('created_at', { ascending: false })
                    .limit(10);
                
                if (error) throw error;
                
                if (data && data.length > 0) {
                    AppState.stats.recentAssignments = data;
                    renderRecentAssignmentsTable(data);
                    AppState.stats.lastUpdate = new Date(data[0].created_at);
                    
                    // Actualizar última actualización en el dashboard
                    el('#stat-last-update').textContent = dayjs(AppState.stats.lastUpdate).format('DD/MM/YYYY HH:mm');
                }
            } catch (error) {
                console.error('Error al cargar asignaciones recientes:', error);
            }
        }
        
        // Renderizar tabla de asignaciones recientes en el dashboard
        function renderRecentAssignmentsTable(data) {
            const tableBody = el('#recent-assignments-table tbody');
            
            if (!data || data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center">No hay asignaciones recientes</td></tr>';
                return;
            }
            
            tableBody.innerHTML = data.map(item => `
                <tr>
                    <td>${formatDate(item.date)}</td>
                    <td>${item.block}</td>
                    <td>${item.staff_name}</td>
                    <td>${item.task}</td>
                    <td>${item.island || '—'}</td>
                    <td>${item.lunch_start ? `${item.lunch_start} - ${item.lunch_end}` : '—'}</td>
                </tr>
            `).join('');
        }
        
        // Actualizar estadísticas del dashboard
        function updateDashboardStats() {
            // Actualizar conteo de personal
            const dayStaff = AppState.staff.filter(s => s.block === 'DIA').length;
            const nightStaff = AppState.staff.filter(s => s.block === 'NOCHE').length;
            const totalStaff = AppState.staff.length;
            
            el('#stat-total-staff').textContent = totalStaff;
            el('#stat-staff-day').textContent = dayStaff;
            el('#stat-staff-night').textContent = nightStaff;
            el('#stat-current-block').textContent = currentBlock();
            
            // Actualizar asignaciones de hoy
            el('#stat-assignments-today').textContent = AppState.rows.length;
            
            // Actualizar islas cubiertas
            updateIslandStats();
            
            // Cargar datos recientes para los gráficos
            loadChartData();
        }
        
        // Actualizar estadísticas de islas
        function updateIslandStats() {
            const islands = AppState.islands.filter(i => i).length; // Número total de islas (sin contar vacío)
            const assignedIslands = new Set();
            
            AppState.rows.forEach(row => {
                if (row.island) assignedIslands.add(row.island);
            });
            
            const coveredCount = assignedIslands.size;
            el('#stat-islands-covered').textContent = `${coveredCount}/${islands}`;
            
            if (coveredCount === 0) {
                el('#stat-uncovered-islands').textContent = 'Todas las islas pendientes';
            } else if (coveredCount < islands) {
                const uncoveredIslands = AppState.islands
                    .filter(i => i && !assignedIslands.has(i))
                    .join(', ');
                el('#stat-uncovered-islands').textContent = `Pendientes: ${uncoveredIslands}`;
            } else {
                el('#stat-uncovered-islands').textContent = 'Todas las islas cubiertas';
            }
        }
        
        // Cargar datos para los gráficos del dashboard
        async function loadChartData() {
            if (!AppState.supabase) return;
            
            try {
                // Obtener datos de los últimos 7 días
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - 6); // 7 días incluyendo hoy
                
                const { data, error } = await AppState.supabase
                    .from('assignments')
                    .select('*')
                    .gte('date', startDate.toISOString().split('T')[0])
                    .lte('date', endDate.toISOString().split('T')[0])
                    .order('date', { ascending: true });
                
                if (error) throw error;
                
                if (data && data.length > 0) {
                    // Procesar datos para gráficos
                    processChartData(data);
                    
                    // Renderizar gráficos
                    renderDashboardCharts();
                }
            } catch (error) {
                console.error('Error al cargar datos para gráficos:', error);
            }
        }
        
        // Procesar datos para gráficos
        function processChartData(data) {
            // Resetear datos
            AppState.stats.assignmentsByDay = {};
            AppState.stats.islandDistribution = {};
            
            // Procesar asignaciones por día
            data.forEach(item => {
                const date = item.date;
                if (!AppState.stats.assignmentsByDay[date]) {
                    AppState.stats.assignmentsByDay[date] = { DIA: 0, NOCHE: 0 };
                }
                AppState.stats.assignmentsByDay[date][item.block]++;
                
                // Procesar distribución de islas
                if (item.island) {
                    if (!AppState.stats.islandDistribution[item.island]) {
                        AppState.stats.islandDistribution[item.island] = 0;
                    }
                    AppState.stats.islandDistribution[item.island]++;
                }
            });
        }
        
        // Renderizar gráficos del dashboard
        function renderDashboardCharts() {
            // Destruir gráficos existentes si los hay
            if (AppState.charts.islands) AppState.charts.islands.destroy();
            if (AppState.charts.assignments) AppState.charts.assignments.destroy();
            
            // Gráfico de distribución por islas
            const islandCtx = document.getElementById('chart-islands');
            if (islandCtx) {
                const labels = Object.keys(AppState.stats.islandDistribution);
                const data = Object.values(AppState.stats.islandDistribution);
                
                AppState.charts.islands = new Chart(islandCtx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: [
                                '#3b82f6', '#22c55e', '#f97316', '#f59e0b', 
                                '#84cc16', '#10b981', '#06b6d4', '#0ea5e9'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right'
                            },
                            title: {
                                display: true,
                                text: 'Distribución por Islas'
                            }
                        }
                    }
                });
            }
            
            // Gráfico de asignaciones por día
            const assignmentsCtx = document.getElementById('chart-assignments');
            if (assignmentsCtx) {
                const dates = Object.keys(AppState.stats.assignmentsByDay).sort();
                const dayData = dates.map(date => AppState.stats.assignmentsByDay[date].DIA);
                const nightData = dates.map(date => AppState.stats.assignmentsByDay[date].NOCHE);
                
                AppState.charts.assignments = new Chart(assignmentsCtx, {
                    type: 'bar',
                    data: {
                        labels: dates.map(date => formatDate(date)),
                        datasets: [
                            {
                                label: 'Día',
                                data: dayData,
                                backgroundColor: '#3b82f6'
                            },
                            {
                                label: 'Noche',
                                data: nightData,
                                backgroundColor: '#1e3a8a'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Asignaciones por Día'
                            }
                        },
                        scales: {
                            x: {
                                stacked: true
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true,
                                ticks: {
                                    precision: 0
                                }
                            }
                        }
                    }
                });
            }
        }
        
        // Generar reporte
        async function generateReport() {
            const startDate = el('#reportStartDate').value;
            const endDate = el('#reportEndDate').value;
            const block = el('#reportBlock').value;
            const staffName = el('#reportStaff').value;
            
            if (!startDate || !endDate) {
                showToast('Error', 'Debe seleccionar fechas de inicio y fin', 'error');
                return;
            }
            
            showLoading('Generando reporte...');
            
            try {
                let query = AppState.supabase
                    .from('assignments')
                    .select('*')
                    .gte('date', startDate)
                    .lte('date', endDate)
                    .order('date', { ascending: false });
                
                if (block !== 'all') {
                    query = query.eq('block', block);
                }
                
                if (staffName !== 'all') {
                    query = query.eq('staff_name', staffName);
                }
                
                const { data, error } = await query;
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    hideLoading();
                    showToast('Sin resultados', 'No se encontraron asignaciones con los criterios seleccionados', 'warning');
                    return;
                }
                
                // Actualizar rango de fechas en el reporte
                el('#reportDateRange').textContent = `${formatDate(startDate)} - ${formatDate(endDate)}`;
                
                // Procesar datos para el reporte
                processReportData(data);
                
                // Renderizar tabla de detalles
                renderReportDetailTable(data);
                
                hideLoading();
                showToast('Reporte generado', `Se encontraron ${data.length} asignaciones`, 'success');
            } catch (error) {
                hideLoading();
                console.error('Error al generar reporte:', error);
                showToast('Error', 'No se pudo generar el reporte', 'error');
            }
        }
        
        // Procesar datos para el reporte
        function processReportData(data) {
            // Conteo básico
            el('#report-total-assignments').textContent = data.length;
            
            // Días cubiertos (únicos)
            const uniqueDays = new Set(data.map(item => item.date)).size;
            el('#report-days-covered').textContent = uniqueDays;
            
            // Personal asignado (único)
            const uniqueStaff = new Set(data.map(item => item.staff_name)).size;
            el('#report-staff-assigned').textContent = uniqueStaff;
            
            // Islas asignadas (únicas)
            const uniqueIslands = new Set(data.filter(item => item.island).map(item => item.island)).size;
            el('#report-islands-assigned').textContent = uniqueIslands;
            
            // Datos para gráficos del reporte
            const taskCounts = {};
            const islandCounts = {};
            
            data.forEach(item => {
                // Contar tareas
                const tasks = item.task.split(' | ');
                tasks.forEach(task => {
                    if (!taskCounts[task]) taskCounts[task] = 0;
                    taskCounts[task]++;
                });
                
                // Contar islas
                if (item.island) {
                    if (!islandCounts[item.island]) islandCounts[item.island] = 0;
                    islandCounts[item.island]++;
                }
            });
            
            // Renderizar gráficos del reporte
            renderReportCharts(taskCounts, islandCounts);
        }
        
        // Renderizar gráficos del reporte
        function renderReportCharts(taskCounts, islandCounts) {
            // Destruir gráficos existentes si los hay
            if (AppState.charts.reportTasks) AppState.charts.reportTasks.destroy();
            if (AppState.charts.reportIslands) AppState.charts.reportIslands.destroy();
            
            // Gráfico de tareas
            const tasksCtx = document.getElementById('report-chart-tasks');
            if (tasksCtx) {
                const labels = Object.keys(taskCounts);
                const data = Object.values(taskCounts);
                
                AppState.charts.reportTasks = new Chart(tasksCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Cantidad',
                            data: data,
                            backgroundColor: '#3b82f6'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Distribución por Tipo de Asignación'
                            },
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0
                                }
                            }
                        }
                    }
                });
            }
            
            // Gráfico de islas
            const islandsCtx = document.getElementById('report-chart-islands');
            if (islandsCtx) {
                const labels = Object.keys(islandCounts);
                const data = Object.values(islandCounts);
                
                AppState.charts.reportIslands = new Chart(islandsCtx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: [
                                '#3b82f6', '#22c55e', '#f97316', '#f59e0b', 
                                '#84cc16', '#10b981', '#06b6d4', '#0ea5e9'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Distribución por Islas'
                            }
                        }
                    }
                });
            }
        }
        
        // Renderizar tabla de detalles del reporte
        function renderReportDetailTable(data) {
            const tableBody = el('#report-detail-table tbody');
            
            if (!data || data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center">No hay datos para mostrar</td></tr>';
                return;
            }
            
            tableBody.innerHTML = data.map(item => `
                <tr>
                    <td>${formatDate(item.date)}</td>
                    <td>${item.block}</td>
                    <td>${item.staff_name}</td>
                    <td>${item.task}</td>
                    <td>${item.island || '—'}</td>
                    <td>${item.lunch_start ? `${item.lunch_start} - ${item.lunch_end}` : '—'}</td>
                </tr>
            `).join('');
        }
        
        // Exportar reporte a CSV
        function exportReportToCsv() {
            const table = el('#report-detail-table');
            if (!table) return;
            
            const rows = table.querySelectorAll('tr');
            if (rows.length <= 1) {
                showToast('Sin datos', 'No hay datos para exportar', 'warning');
                return;
            }
            
            // Obtener encabezados
            const headers = Array.from(rows[0].querySelectorAll('th')).map(th => th.textContent);
            
            // Obtener datos
            const data = [];
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                const cells = row.querySelectorAll('td');
                const rowData = Array.from(cells).map(cell => csvEscape(cell.textContent));
                data.push(rowData.join(','));
            }
            
            // Crear CSV
            const csv = [headers.join(','), ...data].join('\n');
            
            // Descargar
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Reporte_Terminal_El_Roble_${new Date().toISOString().split('T')[0]}.csv`;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('CSV exportado', 'Reporte exportado correctamente', 'success');
        }
        
        // Cargar historial de asignaciones
        async function loadAssignmentHistory() {
            const month = el('#historyMonth').value;
            
            if (!month) {
                showToast('Error', 'Debe seleccionar un mes', 'error');
                return;
            }
            
            showLoading('Cargando historial...');
            
            try {
                const [year, monthNum] = month.split('-');
                const startDate = `${year}-${monthNum}-01`;
                const endDate = new Date(year, monthNum, 0).toISOString().split('T')[0];
                
                const { data, error } = await AppState.supabase
                    .from('assignments')
                    .select('date, block, staff_name, task, island')
                    .gte('date', startDate)
                    .lte('date', endDate)
                    .order('date', { ascending: false });
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    hideLoading();
                    showToast('Sin resultados', 'No se encontraron asignaciones para el mes seleccionado', 'warning');
                    renderHistoryTable([]);
                    return;
                }
                
                // Agrupar por fecha y bloque
                const grouped = {};
                data.forEach(item => {
                    const key = `${item.date}-${item.block}`;
                    if (!grouped[key]) {
                        grouped[key] = {
                            date: item.date,
                            block: item.block,
                            assignments: 0,
                            islands: new Set()
                        };
                    }
                    grouped[key].assignments++;
                    if (item.island) grouped[key].islands.add(item.island);
                });
                
                // Convertir a array para renderizar
                const historyItems = Object.values(grouped).map(item => ({
                    ...item,
                    islands: Array.from(item.islands)
                }));
                
                renderHistoryTable(historyItems);
                hideLoading();
                showToast('Historial cargado', `Se encontraron ${historyItems.length} registros`, 'success');
            } catch (error) {
                hideLoading();
                console.error('Error al cargar historial:', error);
                showToast('Error', 'No se pudo cargar el historial', 'error');
            }
        }
        
        // Renderizar tabla de historial
        function renderHistoryTable(data) {
            const tableBody = el('#history-table tbody');
            
            if (!data || data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center">No hay datos para el período seleccionado</td></tr>';
                return;
            }
            
            tableBody.innerHTML = data.map(item => `
                <tr>
                    <td>${formatDate(item.date)}</td>
                    <td>${item.block}</td>
                    <td>${item.assignments}</td>
                    <td>${item.islands.length ? item.islands.join(', ') : '—'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline" data-action="view-detail" data-date="${item.date}" data-block="${item.block}">
                            <i class="fas fa-eye"></i> Ver
                        </button>
                    </td>
                </tr>
            `).join('');
            
            // Agregar event listeners para los botones de ver detalle
            tableBody.querySelectorAll('[data-action="view-detail"]').forEach(button => {
                button.addEventListener('click', e => {
                    const date = e.target.closest('button').getAttribute('data-date');
                    const block = e.target.closest('button').getAttribute('data-block');
                    openDetailModal(date, block);
                });
            });
        }
        
        // Abrir modal de detalle
        async function openDetailModal(date, block) {
            showLoading('Cargando detalles...');
            
            try {
                const { data, error } = await AppState.supabase
                    .from('assignments')
                    .select('*')
                    .eq('date', date)
                    .eq('block', block)
                    .order('staff_name', { ascending: true });
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    hideLoading();
                    showToast('Sin resultados', 'No se encontraron detalles para esta fecha y bloque', 'warning');
                    return;
                }
                
                // Actualizar datos del modal
                el('#modal-date').textContent = formatDate(date);
                el('#modal-block').textContent = block;
                
                // Renderizar tabla de detalles
                const tableBody = el('#modal-assignments-table tbody');
                tableBody.innerHTML = data.map(item => `
                    <tr>
                        <td>${item.staff_name}</td>
                        <td>${item.task}</td>
                        <td>${item.island || '—'}</td>
                        <td>${item.lunch_start ? `${item.lunch_start} - ${item.lunch_end}` : '—'}</td>
                    </tr>
                `).join('');
                
                // Mostrar modal
                el('#detailModal').classList.add('show');
                
                // Guardar datos para PDF
                el('#btnModalExportPdf').setAttribute('data-date', date);
                el('#btnModalExportPdf').setAttribute('data-block', block);
                
                hideLoading();
            } catch (error) {
                hideLoading();
                console.error('Error al cargar detalles:', error);
                showToast('Error', 'No se pudo cargar los detalles', 'error');
            }
        }
        
        // Exportar detalle a PDF
        async function exportDetailToPdf() {
            const date = el('#btnModalExportPdf').getAttribute('data-date');
            const block = el('#btnModalExportPdf').getAttribute('data-block');
            
            if (!date || !block) return;
            
            showLoading('Generando PDF...');
            
            try {
                const { data, error } = await AppState.supabase
                    .from('assignments')
                    .select('*')
                    .eq('date', date)
                    .eq('block', block)
                    .order('staff_name', { ascending: true });
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    hideLoading();
                    showToast('Sin datos', 'No hay datos para exportar', 'warning');
                    return;
                }
                
                // Generar PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    unit: 'mm',
                    format: 'a4',
                    orientation: 'portrait'
                });
                
                // Header with background
                doc.setFillColor(15, 60, 110);
                doc.rect(0, 0, 210, 30, 'F');
                
                // Title
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(16);
                doc.text('Terminal El Roble - Detalle de Asignaciones', 15, 15);
                
                // Subtitle
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                const dateFormatted = formatDate(date);
                doc.text(`Fecha: ${dateFormatted}   Bloque: ${block}   Registros: ${data.length}`, 15, 23);
                
                // Table
                const tableColumn = ['Personal', 'Asignación', 'Isla', 'Colación'];
                const tableRows = data.map(item => [
                    item.staff_name,
                    item.task,
                    item.island || '—',
                    item.lunch_start ? `${item.lunch_start} - ${item.lunch_end}` : '—'
                ]);
                
                doc.autoTable({
                    head: [tableColumn],
                    body: tableRows,
                    startY: 40,
                    theme: 'grid',
                    styles: {
                        fontSize: 10,
                        cellPadding: 4,
                        lineColor: [222, 226, 230],
                        lineWidth: 0.1
                    },
                    headStyles: {
                        fillColor: [15, 60, 110],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold'
                    },
                    alternateRowStyles: {
                        fillColor: [240, 245, 255]
                    },
                    margin: { top: 40, left: 15, right: 15, bottom: 20 }
                });
                
                // Footer
                const pageCount = doc.internal.getNumberOfPages();
                doc.setFontSize(8);
                doc.setTextColor(100, 100, 100);
                
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.text(`Página ${i} de ${pageCount} - Terminal El Roble`, 15, doc.internal.pageSize.height - 10);
                    doc.text(`Generado: ${new Date().toLocaleString()}`, doc.internal.pageSize.width - 15, doc.internal.pageSize.height - 10, { align: 'right' });
                }
                
                hideLoading();
                
                // Save the PDF
                doc.save(`Terminal_El_Roble_Detalle_${date}_${block}.pdf`);
                showToast('PDF generado', 'Detalle exportado correctamente', 'success');
            } catch (error) {
                hideLoading();
                console.error('Error al exportar detalle:', error);
                showToast('Error', 'No se pudo exportar el detalle', 'error');
            }
        }
        
        // Llenar selector de personal en reportes
        function populateStaffSelect() {
            const select = el('#reportStaff');
            if (!select) return;
            
            // Limpiar opciones existentes excepto la primera
            const firstOption = select.options[0];
            select.innerHTML = '';
            select.appendChild(firstOption);
            
            // Agregar personal ordenado alfabéticamente
            const staffNames = AppState.staff
                .map(s => s.name)
                .sort((a, b) => a.localeCompare(b));
            
            staffNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            });
        }
        
        // ===== Navegación por pestañas =====
        function setupTabs() {
            // Agregar event listeners a los links de navegación
            all('.nav-link').forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    const tabId = e.target.closest('.nav-link').getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            // Eventos para ver todas las asignaciones desde el dashboard
            el('#btnViewAllAssignments')?.addEventListener('click', e => {
                e.preventDefault();
                switchTab('history');
            });
        }
        
        function switchTab(tabId) {
            // Guardar tab activa en el estado
            AppState.ui.activeTab = tabId;
            
            // Actualizar clases de navegación
            all('.nav-link').forEach(link => {
                const isActive = link.getAttribute('data-tab') === tabId;
                link.classList.toggle('active', isActive);
            });
            
            // Mostrar/ocultar contenido de pestañas
            all('.tab-content').forEach(tab => {
                const isActive = tab.id === `${tabId}-tab`;
                tab.classList.toggle('active', isActive);
            });
            
            // Actualizar título de la página
            const title = el('.nav-link.active')?.textContent.trim() || 'Terminal El Roble';
            el('.app-title').textContent = title;
            
            // Si se cambia a dashboard o reportes, actualizar datos
            if (tabId === 'dashboard') {
                updateDashboardStats();
                loadRecentAssignments();
            } else if (tabId === 'reports') {
                // Establecer fechas por defecto en el reporte si están vacías
                if (!el('#reportStartDate').value) {
                    const startDate = new Date();
                    startDate.setDate(startDate.getDate() - 30);
                    el('#reportStartDate').value = startDate.toISOString().split('T')[0];
                }
                
                if (!el('#reportEndDate').value) {
                    el('#reportEndDate').value = todayISO();
                }
            } else if (tabId === 'history') {
                // Establecer mes actual en el selector de historial si está vacío
                if (!el('#historyMonth').value) {
                    const today = new Date();
                    el('#historyMonth').value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
                }
            }
        }
        
        // ===== Modal =====
        function setupModal() {
            // Cerrar modal
            el('#closeDetailModal')?.addEventListener('click', () => {
                el('#detailModal').classList.remove('show');
            });
            
            el('#btnCloseDetailModal')?.addEventListener('click', () => {
                el('#detailModal').classList.remove('show');
            });
            
            // Cerrar modal al hacer clic fuera
            el('#detailModal')?.addEventListener('click', e => {
                if (e.target === el('#detailModal')) {
                    el('#detailModal').classList.remove('show');
                }
            });
            
            // Exportar a PDF
            el('#btnModalExportPdf')?.addEventListener('click', exportDetailToPdf);
        }

        // ===== Wire UI Events =====
        function wireUIEvents() {
            // Set default date
            el('#date').value = todayISO();
            el('#currentDate').textContent = formatDate(todayISO());

            // Tab controls
            el('#tabDia').addEventListener('click', () => {
                el('#block').value = 'DIA';
                setActiveTab('DIA');
                renderStaffList();
            });

            el('#tabNoche').addEventListener('click', () => {
                el('#block').value = 'NOCHE';
                setActiveTab('NOCHE');
                renderStaffList();
            });

            el('#block').addEventListener('change', () => {
                setActiveTab(currentBlock());
                renderStaffList();
            });

            // Date change
            el('#date').addEventListener('change', (e) => {
                el('#currentDate').textContent = formatDate(e.target.value);
            });

            // Mobile menu toggle
            el('#toggleSidebar')?.addEventListener('click', () => {
                el('.app-sidebar').classList.toggle('show');
            });

            // Staff controls
            el('#btnReloadStaff').addEventListener('click', loadStaff);
            el('#btnReloadStaffEmpty')?.addEventListener('click', loadStaff);
            el('#availabilityFilter').addEventListener('change', renderStaffList);
            el('#searchStaff').addEventListener('input', renderStaffList);

            el('#btnSelectAll').addEventListener('click', () => {
                const block = currentBlock();

                AppState.staff.filter(staff => staff.block === block).forEach(staff => {
                    AppState.selectedStaff.add(staff.id);
                });

                renderStaffList();
                updateSelectedCountBadge();
            });

            el('#btnClear').addEventListener('click', () => {
                AppState.selectedStaff.clear();
                renderStaffList();
                updateSelectedCountBadge();
            });

            // Row controls
            el('#btnAddRows').addEventListener('click', () => {
                const selectedStaff = AppState.staff.filter(staff =>
                    AppState.selectedStaff.has(staff.id) && staff.block === currentBlock()
                );

                if (!selectedStaff.length) {
                    showToast('Sin selección', 'Selecciona personal primero', 'warning');
                    return;
                }

                selectedStaff.forEach(staff => {
                    addRow(defaultRowForBlock({ name: staff.name }));
                });

                showToast('Filas agregadas', `${selectedStaff.length} filas agregadas`, 'success');
                
                // Actualizar estadísticas del dashboard
                updateDashboardStats();
            });

            el('#btnAddEmpty').addEventListener('click', () => {
                addRow(defaultRowForBlock({}));
                showToast('Fila agregada', 'Fila vacía agregada', 'success');
            });

            el('#btnClearRows').addEventListener('click', () => {
                if (!AppState.rows.length) return;

                if (confirm('¿Estás seguro de vaciar la tabla de asignaciones?')) {
                    AppState.rows = [];
                    renderRows();
                    showToast('Tabla vaciada', 'La tabla ha sido vaciada correctamente', 'success');
                    
                    // Actualizar estadísticas del dashboard
                    updateDashboardStats();
                }
            });

            // Export/save controls
            el('#btnSave').addEventListener('click', saveAssignments);
            el('#btnPdfMaster').addEventListener('click', makeMasterPdf);
            el('#btnPdfIndividuals').addEventListener('click', makeIndividualPdfs);
            el('#btnExportCsv').addEventListener('click', exportCSV);

            // Additional functionalities
            el('#btnAutoIslas').addEventListener('click', autoAssignIslands);
            
            // Reportes
            el('#btnGenerateReport')?.addEventListener('click', generateReport);
            el('#btnExportReportCsv')?.addEventListener('click', exportReportToCsv);
            
            // Historial
            el('#btnLoadHistory')?.addEventListener('click', loadAssignmentHistory);
            
            // Configuración de pestañas y modal
            setupTabs();
            setupModal();
        }

        function setActiveTab(block) {
            el('#tabDia').classList.toggle('active', block === 'DIA');
            el('#tabNoche').classList.toggle('active', block === 'NOCHE');
            el('#currentBlock').textContent = block;

            // Update btn-primary class for styling
            if (block === 'DIA') {
                el('#tabDia').classList.add('btn-primary');
                el('#tabDia').classList.remove('btn');
                el('#tabNoche').classList.add('btn');
                el('#tabNoche').classList.remove('btn-primary');
            } else {
                el('#tabNoche').classList.add('btn-primary');
                el('#tabNoche').classList.remove('btn');
                el('#tabDia').classList.add('btn');
                el('#tabDia').classList.remove('btn-primary');
            }
        }

        // ===== Initialize Application =====
        (function initApp() {
            try {
                console.log('Iniciando sistema de Terminal El Roble v5.0...');

                // Inicializar Supabase
                AppState.supabase = initSupabase();

                if (AppState.supabase) {
                    console.log('Conexión a Supabase establecida correctamente');
                } else {
                    console.warn('No se pudo conectar a Supabase - funcionando en modo local');
                }

                // Configurar eventos de UI
                wireUIEvents();

                // Configuración inicial de fecha y bloque
                const today = new Date();
                const currentHour = today.getHours();

                // Si estamos entre las 18:00 y las 6:00, seleccionamos NOCHE por defecto
                if (currentHour >= 18 || currentHour < 6) {
                    el('#block').value = 'NOCHE';
                    setActiveTab('NOCHE');
                } else {
                    el('#block').value = 'DIA';
                    setActiveTab('DIA');
                }

                // Cargar personal automáticamente al inicio
                loadStaff();
                
                // Cargar datos recientes para el dashboard
                loadRecentAssignments();

                console.log('Sistema inicializado correctamente');
                showToast('Sistema listo', 'Terminal El Roble v5.0 inicializado correctamente', 'success');
            } catch (error) {
                console.error('Error al inicializar el sistema:', error);
                showToast('Error de inicialización', 'Ocurrió un error al iniciar el sistema', 'error');
            }
        })();

        // ===== Guardar configuración en localStorage =====
        function saveSettings() {
            const settings = {
                lastDate: el('#date').value,
                lastBlock: currentBlock(),
                availabilityFilter: el('#availabilityFilter').value,
                activeTab: AppState.ui.activeTab
            };

            try {
                localStorage.setItem('terminalRobleSettings', JSON.stringify(settings));
            } catch (e) {
                // Si localStorage no está disponible, no hacer nada
                console.warn('No se pudo guardar la configuración');
            }
        }

        // ===== Cargar configuración de localStorage =====
        function loadSettings() {
            try {
                const savedSettings = localStorage.getItem('terminalRobleSettings');
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);

                    // Restaurar fecha si está en el futuro o es hoy
                    if (settings.lastDate) {
                        const savedDate = new Date(settings.lastDate);
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);

                        if (savedDate >= today) {
                            el('#date').value = settings.lastDate;
                            el('#currentDate').textContent = formatDate(settings.lastDate);
                        }
                    }

                    // Restaurar bloque
                    if (settings.lastBlock) {
                        el('#block').value = settings.lastBlock;
                        setActiveTab(settings.lastBlock);
                    }

                    // Restaurar filtro de disponibilidad
                    if (settings.availabilityFilter) {
                        el('#availabilityFilter').value = settings.availabilityFilter;
                    }
                    
                    // Restaurar pestaña activa
                    if (settings.activeTab) {
                        switchTab(settings.activeTab);
                    }
                }
            } catch (e) {
                // Si hay algún error al cargar la configuración, usar valores predeterminados
                console.warn('No se pudo cargar la configuración guardada');
            }
        }

        // Guardar configuración al cambiar opciones importantes
        el('#date')?.addEventListener('change', saveSettings);
        el('#block')?.addEventListener('change', saveSettings);
        el('#availabilityFilter')?.addEventListener('change', saveSettings);

        // Intentar cargar configuración al iniciar
        document.addEventListener('DOMContentLoaded', loadSettings);

        // ===== Atajos de teclado =====
        document.addEventListener('keydown', (e) => {
            // Ctrl+S para guardar
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveAssignments();
            }

            // Ctrl+P para PDF general
            if (e.ctrlKey && e.key === 'p' && !e.shiftKey) {
                e.preventDefault();
                makeMasterPdf();
            }

            // Ctrl+Shift+P para PDFs individuales
            if (e.ctrlKey && e.shiftKey && e.key === 'P') {
                e.preventDefault();
                makeIndividualPdfs();
            }

            // Ctrl+A para seleccionar todos
            if (e.ctrlKey && e.key === 'a' && document.activeElement === document.body) {
                e.preventDefault();
                el('#btnSelectAll').click();
            }
            
            // Escape para cerrar modal
            if (e.key === 'Escape') {
                const modal = el('#detailModal');
                if (modal && modal.classList.contains('show')) {
                    modal.classList.remove('show');
                }
            }
        });

        // ===== Confirmación al cerrar la página =====
        window.addEventListener('beforeunload', (e) => {
            if (AppState.rows.length > 0) {
                // Mensaje estándar (el texto real lo controla el navegador)
                const message = '¿Seguro que deseas salir? Hay asignaciones sin guardar.';
                e.returnValue = message;
                return message;
            }
        });
</script>

</body>
</html>
